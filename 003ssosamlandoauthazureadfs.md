# 003SSOSamlAndOAuthAzureAdfs

:::: # Active Directory, ADFS, and Azure with SAML 2.0\[] This section is provided for the convenience of our users who use Microsoft ADFS and/or Azure for SSO. It is not intended to be used for a complete deployment, troubleshooting, or configuration guide. For technical support regarding these Microsoft products, a wealth of information is available at Microsoft and other sites, including: - [https://docs.microsoft.com](https://docs.microsoft.com) - [https://techcommunity.microsoft.com](https://techcommunity.microsoft.com) - [https://msdn.microsoft.com](https://msdn.microsoft.com) - [Integrating SAML support with ADFS](https://www2.microstrategy.com/producthelp/10.8/SystemAdmin/WebHelp/Lang_1033/Content/Admin/integrate_saml_with_adfs.md) ## How to Set Up a Federation with the System using ADFS 2.0 Two steps are required to set up a federation between ADFS 2.0, the IdP, and the system, which is a trusted resource in this scenario. You will need to obtain an X.509 certificate and establish a trust relationship between the system and the ADFS 2.0 server. In this scenario, the user enters the URL for the system in a browser or clicks a link from an email. When the system receives the request, it checks the request to determine if the user has been authenticated. If the authentication data is present, the user can access the system and is redirected back to the URL that they were initially attempting to access. If the authentication data is not present, the request is redirected to an ADFS server for authentication. The system includes the X.509 certificate in any requests to authenticate the user. If the X.509 certificate is valid, the user is asked to login through ADFS. If authenticated, the request is redirected back to the original URL. For all pieces to work correctly in this scenario, you must complete two steps. 1. Obtain the certificate from the ADFS side and import it or upload it to the system. 2. Import data about the system into ADFS. ADFS requires this step when configuring a Relying Party Trust. ## Importing or Uploading the ADFS Certificates To set up the certificate on the ADFS side, you can use a self-signed certificate generated by ADFS or use a different certificate. Two approaches can be used. The recommended approach requires fewer manual steps. In this approach, the certificate is contained in the metadata XML file. The metadata can be downloaded from https://\<server>/federationmetadata/2007-06/federationmetadata.xml, where \<server> is the ADFS server. The metadata must then be imported to the system in the Enable Single Sign-On (SAML 2.0) section: - **UKG Ready™ Partners**: This is done in the **Login/Logout Preferences** widget in the **Company Information** page. - **UKG Ready™ Customers**: This is done in the **Login/Logout Preferences** widget in the **Global Setup** > **Company Information** page.  ### Multiple X.509 Certificates Multiple X.509 certificates can be uploaded, and as a result, a new certificate can be uploaded alongside a soon-to-expire certificate to allow a simpler transition from the old certificate to the new one. Expired or duplicate certificates cannot be uploaded, and a warning displays if a duplicate is uploaded. When a certificate is no longer valid, it is automatically removed after 15 days. Certificates display in a table for better readability. An option to **Replace Existing Certificates** is available when importing metadata. When enabled, importing metadata deletes the existing certificate(s) and replaces it with the one from the metadata. Expired certificates are hidden by default, and they can be shown when the **Show Expired Certificates** checkbox is enabled. This checkbox is only visible when the company has any expired certificates. The **Valid To** date displays in red for expired certificates. ::: \[\[**Note:** ]]If all certificates are expired, the **Show Expired Certificates** checkbox is always enabled and all expired certificates are always shown. ::: ## Manual Process (Not recommended) As an alternative, the certificate can be downloaded directly by logging into the ADFS server. 1. Start the Microsoft Management Console. You will need to run the Microsoft Management Console (MMC) program by clicking on **Start**, then selecting **Run** and entering "MMC". 2. Start the Certificate Snap-in Wizard. Click on the **File** menu option and select **Add/Remove Snap-in...** Then select **Certificates** and click on **Add**. 3. Specify where to get the file. After the Certificate Snap-in wizard starts, select **Computer account** and click the **Next** button. Since you are pulling the file from the local system, select **Local computer,** then click the **Finish** button and then click **OK**. 4. Select the certificate. Expand **Console Root\Certificates (Local Computer)\Personal\Certificates**. Select the X.509 certificate by right-clicking on it. Select **All Tasks**, then click **Export** and then click **Next**. Choose **No, do not export the private key option**, then click **Next**. Choose the **Base-64 encoded x.509(.CER)** option, then click **Next**. Enter a file path and name then click the **Next** button. You should see a pop-up reading **The export was successful**, and you can click OK, then save and upload the exported file into the system using the **Upload X.509 Certificate** option.  ## Configuring Relying Party Trust Information The ADFS 2.0 Management snap-in will be used to configure Relying Party Trust Information. From that tool, you can navigate to **ADFS 2.0 > Trust Relationships > Relying Party Trusts**. You'll need to right-click on **Relying Party Trusts** and select **Add Relying Party Trust**. A wizard will start. Click the **Start** button. Two options are available, an import and manual text entry. The import option is recommended. Manual entry should only be used if your IdP cannot import the data from a file. This is not the case with ADFS. ### Recommended Option: Importing the Service Provider Data into ADFS If you have exported service provider metadata from the **Login/Logout Preferences** widget, you can upload the file. Within the **Relying Party Trust** wizard, choose **Select Data Source** and upload the file using the **Import data about the relying party from a file** option.  For **Display** name, enter any name (for example, **Trusted Resource**) and click the **Next** button. ### Manually Entering the Relying Party Information If your IdP cannot import a file, the alternative is to choose **Enter data about the relying party manually** option and click the **Next** button. You'll need to step through each of the sections in the **Relying Party Trust** wizard. 1. In the **Specify Display Name** section, enter any name for **Display** (for example, **Trusted Resource**) and click the **Next** button. 2. For the **Choose Profile** section, select **AD FS 2.0 profile** and click the **Next** button. 3. For the **Configure Certificate** section, click the **Next** button as the system does not support a token encryption certificate.  4. For the **Configure URL** section, check **Enable support for SAML 2.0 Web SSO protocol**. For the **Relying party SAML 2.0 SSO** service URL, enter the Service Provider (SP) URL. This is the Endpoint URL shown in the **Service Provider Information** in the **Login/Logout Preferences** widget.  5. Click the **Next** button. 6. In the **Configure Identifiers** section, you'll need to enter some system URLs. In the **Relying party trust identifier**, the system's SAML endpoint needs to be entered. This is the Audience URL shown in the **Service Provider Information** in the **Login/Logout Preferences** screen, for example: [https://secure2.saashr.com](https://secure2.saashr.com)  7. Click the **Add** button then click the **Next** button. 8. For the **Choose Issuance Authorization Rules** section, select **Permit all users to access this relying party** then click the **Next** button. 9. For the **Ready to Add Trust section**, you can review the configuration on this screen. Once you are satisfied with the information click the **Next** button. 10. Click the **Close** button. ### Claim Rules You should now see a dialog box to add Claim rules to the **Trusted Resource** relying party that was just configured. There is only one claim that needs configuration before sending to the system: Name ID. The next steps show you how to configure this. As with any federation configuration, case sensitivity is critical. Please make sure to use the matching case when configuring the claim names. 1. In the **Trusted Resource Claim** rules click the **Add** button. 2. For the Claim rule template field, select **Send LDAP attributes as Claims** then click the **Next** button. 3. Enter any name for the Claim rule name, for example, **Name ID.** 4. For the **Attribute store** field, drop down and select **Active Directory**. 5. In the **LDAP Attribute** section, drop down and select **SAM-Account-Name**. 6. In the **Outgoing Claim Type** section, drop down and select **Name ID**.\ \  7. Click the **Finish** button. 8. Click the **OK** button on the Claim rule configuration for **Trusted Resource**. Since we have configured this as a SAML assertion we can use the LoginToRP feature with the IDPInitiatedSignon page to get the users signed into ADFS and then redirect them to WFR. Here is an example of this assuming that the ADFS server name is adfs.example.com. The URL would be: https://adfs.example.com/adfs/ls/IDPInitiatedSignon.aspx?LoginToRP=https://secure.entertimeonline.com ::::
